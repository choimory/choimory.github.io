---
title: "로그 기반 복구(Log-based Recovery)"
date: 2025-10-31T00:00:00
toc: true
toc_sticky: true
categories:
    - DevOps
tags:
    - Log
    - Recovery
---

# 로그 기반 복구(Log-based Recovery)

- *로그 기반 복구(Log-based Recovery)*는 **데이터베이스 시스템에서 장애 발생 시 트랜잭션을 복구**하기 위해 사용되는 방법이다.
- 이 방식은 트랜잭션이 수행한 모든 작업을 **로그 파일**에 기록하여, 장애가 발생했을 때 로그를 참조해 데이터베이스를 **일관된 상태로 복구**할 수 있게 해준다.

---

# 로그 기반 복구의 핵심 개념

## **트랜잭션 로그(Transaction Log)**:

- 데이터베이스에서 트랜잭션이 수행하는 **모든 변경 사항**을 기록하는 파일이다.
- 트랜잭션 로그는 보통 **WAL(Write-Ahead Logging)** 기법을 사용하며, 데이터가 실제 데이터베이스에 반영되기 전에 먼저 로그 파일에 기록된다.
- 트랜잭션 로그에는 다음과 같은 정보가 포함된다:
    - 트랜잭션 시작 및 종료 시간
    - 데이터 변경 이전 값(**Before Image**)과 변경 후 값(**After Image**)
    - 데이터 변경을 위한 SQL 명령어와 해당 레코드 정보

## **WAL (Write-Ahead Logging)**:

- **WAL**은 데이터가 실제로 데이터베이스에 적용되기 전에, 먼저 트랜잭션 로그에 기록하는 방식이다.
- 즉, 로그 파일에 변경 내용을 기록한 후에 데이터베이스에 반영하기 때문에, 시스템 장애 발생 시 로그를 기반으로 **트랜잭션의 복구**가 가능하다.
- **안전성 보장**:
    - 장애가 발생해도 로그를 바탕으로 트랜잭션을 롤백하거나 커밋할 수 있기 때문에 데이터 일관성을 보장한다.

## **UNDO 및 REDO**:

- **UNDO(롤백)**:
    - 장애 발생 시 커밋되지 않은 트랜잭션에 대해 로그를 참조하여 **변경 전 상태로 복구**하는 작업이다.
    - 트랜잭션이 완료되지 않았기 때문에, 해당 트랜잭션이 수행한 작업을 모두 취소한다.
- **REDO(재실행)**:
    - 커밋된 트랜잭션에 대해 로그를 참조하여 **변경 사항을 재적용**하는 작업이다.
    - 트랜잭션이 이미 완료된 상태지만, 장애로 인해 데이터베이스에 반영되지 않았을 수 있기 때문에, 로그를 이용해 변경 사항을 다시 적용한다.

---

# 로그 기반 복구 과정

## **정상 실행 중 로그 기록**:

- 트랜잭션이 시작되면 그 과정에서 발생하는 **모든 데이터 변경 작업**을 트랜잭션 로그에 기록한다.
- 변경 전 데이터(**Before Image**)와 변경 후 데이터(**After Image**) 모두 기록된다.
- 트랜잭션이 성공적으로 완료되어 **커밋**되면, 트랜잭션이 성공적으로 끝났음을 나타내는 커밋 기록이 로그에 추가된다.

## **장애 발생**:

- 시스템 장애가 발생하면, 데이터베이스에 반영되지 않은 트랜잭션의 상태가 일관되지 않을 수 있다.
- 로그 파일은 이때 데이터를 복구하기 위한 정보를 제공한다.

## **복구 시 로그 활용**:

- **REDO 단계**:
    - 커밋된 트랜잭션 중, 장애로 인해 데이터베이스에 반영되지 않은 변경 사항이 있는 경우 **로그를 기반으로 변경 작업을 다시 실행**한다.
    - 이렇게 하면, 커밋된 트랜잭션의 변경 사항이 데이터베이스에 확실히 반영된다.
- **UNDO 단계**:
    - 커밋되지 않은 트랜잭션에 대해서는 **로그를 사용해 변경 사항을 취소(롤백)**한다.
    - 트랜잭션 로그에 기록된 **Before Image**를 사용하여, 트랜잭션이 변경하기 전 상태로 되돌린다.

---

# 로그 기반 복구 예시

## **트랜잭션 로그 기록**:

- 트랜잭션이 시작되고, 데이터베이스에서 `A` 값을 100에서 150으로 변경하는 경우:

```yaml
[BEGIN TRANSACTION T1]
[T1: UPDATE A, BEFORE: 100, AFTER: 150]
```

## **트랜잭션 커밋**:

- 트랜잭션이 성공적으로 완료되면 로그에 커밋이 기록된다:

```csharp
[COMMIT T1]
```

## **장애 발생 후 복구**:

- 시스템 장애로 인해 `T1` 트랜잭션이 완료된 후 변경 사항이 디스크에 반영되지 않았다면, **REDO 단계**에서 로그에 기록된 **After Image**(`A = 150`)를 데이터베이스에 다시 적용한다.
- 만약 트랜잭션이 커밋되지 않은 상태에서 장애가 발생했다면, **UNDO 단계**에서 **Before Image**(`A = 100`)를 사용해 원래 상태로 복구한다.

---

# 장점

## **데이터 일관성 보장**:

- 로그 기반 복구는 **트랜잭션의 원자성(Atomicity)**과 **일관성(Consistency)**을 보장한다.
- 장애가 발생하더라도, 로그를 사용하여 트랜잭션의 변경 사항을 취소하거나 다시 적용함으로써 데이터 일관성을 유지할 수 있다.

## **비용 효율적**:

- 로그 기반 복구는 데이터를 매번 백업하지 않고, **변경된 사항만 기록**하므로 디스크 공간을 절약할 수 있다.
- 또한, 전체 데이터를 복구할 필요 없이 **변경된 부분만 복구**할 수 있어 복구 속도도 빠르다.

## **최소한의 손실**:

- WAL 기법을 통해 로그가 먼저 기록되기 때문에, 장애가 발생하더라도 **최소한의 데이터 손실**로 복구할 수 있다.
- 로그 기반 복구는 실시간 성격의 트랜잭션 처리 시스템에 매우 적합하다.

---

# 단점

## **로그 파일 크기 증가**:

- 트랜잭션 로그에 모든 변경 사항을 기록하기 때문에, 로그 파일이 **매우 커질 수 있다**.
- 주기적인 로그 관리가 필요하며, 오래된 로그는 백업 후 제거해야 한다.

## **복구 시간 증가**:

- 로그에 기록된 트랜잭션을 **모두 재실행**해야 하므로, 로그 파일이 클수록 복구 시간이 길어질 수 있다.
- 특히, 로그 파일의 크기와 장애가 발생한 시점에 따라 **REDO/UNDO 작업**이 많아질 수 있다.

---

# 정리

- **로그 기반 복구**는 트랜잭션의 모든 작업을 로그에 기록하여 **데이터베이스의 일관성을 보장**하고, 장애 발생 시 **데이터를 복구**하는 중요한 방식이다.
- 특히 **WAL 기법**을 통해 로그가 먼저 기록되기 때문에 데이터 손실을 최소화할 수 있으며, 장애 시에도 **REDO**와 **UNDO** 과정을 통해 트랜잭션의 정확한 상태를 유지할 수 있다.
- 다만, 로그 파일 관리와 복구 성능을 고려한 설계가 필요하다.